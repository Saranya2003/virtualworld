version: "3.3"

services:
  gis:
    image: postgis/postgis
    container_name: postgis
    volumes:
      - ./data/gis:/var/lib/postgres/data
    environment:
      - POSTGRES_DB=cyberphysical
      - POSTGRES_USER=cyberphysical
      - POSTGRES_PASSWORD=cyberpass
    ports:
      - "4321:4321"

  relstorage:
    image: postgres
    container_name: postgresdb
    volumes:
      - ./data/db:/var/lib/postgres/data
    environment:
      - POSTGRES_DB=cyberphysical
      - POSTGRES_USER=cyberphysical
      - POSTGRES_PASSWORD=cyberpass
    ports:
      - "4322:5432"

  redis:
    image: redis
    container_name: redis
    volumes:
      - ./data/redis:/var/lib/redis/data
    ports:
      - "6878:6979"

  minio:
    image: bitnami/minio:latest
    container_name: minio_storage
    volumes:
      - ./data/minio:/data
    ports:
      - '9000:9000' #API SERVER
      - '9001:9001' #ADMIN WEB
    environment:
      - MINIO_ROOT_USER=cyberphysical
      - MINIO_ROOT_PASSWORD=cyberpass
      - MINIO_DEFAULT_BUCKETS=cyberp
      - MINIO_SITE_NAME=cyberp-1
      - MINIO_REGION=thai
    

  cyber-physical-system:
    build: .
    container_name: django
    command: bash -c "(yes yes|python3 manage.py collectstatic) && python3 manage.py migrate && daphne -e ssl:8000:privateKey=key.pem:certKey=cert.pem core.asgi:application"
    volumes:
      - .:/code
    ports:
      - "2077:8000"
    environment:
      - DB_HOST=relstorage
      - GIS_HOST=gis
      - DB_NAME=cyberphysical
      - DB_USER=cyberphysical
      - DB_PASS=cyberpass
      - REDIS_HOST=redis
      - FLUSH_DB=true
      - SPACES_NAME=cyberp
      - SPACES_KEY=cyberphysical
      - SPACES_SECRET=cyberpass
      - SPACES_REGION=thai
      - SPACES_ENDPOINT=http://minio:9000/
    depends_on:
      - gis
      - relstorage
      - redis

  worker:
    build: .
    container_name: roomworkers
    command: celery -A core worker --loglevel=info
    volumes:
      - .:/code
    environment:
      - DB_HOST=relstorage
      - GIS_HOST=gis
      - DB_NAME=cyberphysical
      - DB_USER=cyberphysical
      - DB_PASS=cyberpass
      - REDIS_HOST=redis
    depends_on:
      - cyber-physical-system
      - gis
      - relstorage
      - redis